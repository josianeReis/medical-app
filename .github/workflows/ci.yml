name: CI / CD with Moon ↔ Docker ↔ Coolify

on:
  push:
    branches: [main] # production deploys
  pull_request: # preview deploys
    types: [opened, synchronize, reopened]

#--- GLOBAL SETTINGS ---------------------------------------------------------

permissions: # least-privilege for all jobs
  contents: read
  pull-requests: write # so Moon can post its report comment
  packages: write # push to the private registry

env:
  REGISTRY: ${{ vars.REGISTRY_URL }}

#--- 1. FIGURE OUT WHAT CHANGED ----------------------------------------------

jobs:
  affected:
    name: Detect affected projects
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
      docker_matrix: ${{ steps.docker.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: moonrepo/setup-toolchain@v0 # installs Moon + caches binary

      - id: set
        name: Build project matrix (changed only)
        run: |
          LIST=$(moon query touched-files | moon query projects --affected --json | \
                 jq -r '.projects[].id'            | \
                 jq -R -s -c 'split("\n")[:-1]')
          echo "matrix={\"project\":$LIST}" >>"$GITHUB_OUTPUT"

      - id: docker
        name: Build Docker project matrix (projects with Docker tasks only)
        run: |
          # Get all affected projects
          AFFECTED=$(moon query touched-files | moon query projects --affected --json | jq -r '.projects[].id')
          
          # Filter projects that have docker-release-pr or docker-release-prod tasks
          DOCKER_PROJECTS=()
          while IFS= read -r project; do
            if moon query tasks --project "$project" --json | jq -e ".tasks.$project | has(\"docker-release-pr\") or has(\"docker-release-prod\")" > /dev/null 2>&1; then
              DOCKER_PROJECTS+=("$project")
            fi
          done <<< "$AFFECTED"
          
          # Convert to JSON array
          if [ ${#DOCKER_PROJECTS[@]} -eq 0 ]; then
            LIST="[]"
          else
            LIST=$(printf '%s\n' "${DOCKER_PROJECTS[@]}" | jq -R -s -c 'split("\n")[:-1]')
          fi
          echo "matrix={\"project\":$LIST}" >>"$GITHUB_OUTPUT"

  #--- 2. QUALITY GATES (lint + build) ----------------------------------------

  checks:
    name: Lint / Build gates
    runs-on: ubuntu-latest
    needs: affected # just to use the same checkout
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: moonrepo/setup-toolchain@v0

      - name: Moon CI – lint + build (affected only)
        env:
          REGISTRY: ${{ env.REGISTRY }}
        run: |
          moon ci :lint :build

      # Pretty report in PR comment + workflow summary
      - name: Post Moon run-report
        if: always() # run even if lint/build failed
        uses: moonrepo/run-report-action@v1
        with:
          access-token: ${{ secrets.GITHUB_TOKEN }}

  #--- 3. BUILD & PUSH DOCKER IMAGES (matrix) ---------------------------------

  build:
    name: Build + push Docker images
    needs: [checks, affected] # don't start if lint/build failed
    if: needs.checks.result == 'success' && needs.affected.outputs.docker_matrix != '{"project":[]}'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJSON(needs.affected.outputs.docker_matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - uses: moonrepo/setup-toolchain@v0

      - name: Build & push image for ${{ matrix.project }}
        env:
          REGISTRY: ${{ env.REGISTRY }}
        run: |
          ##################################################################
          # 1. Decide which tag to use (pr-Numbers for previews, SHA for main)
          ##################################################################
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            export TAG="${{ github.event.pull_request.number }}"
          else
            export TAG="${{ github.sha }}"
          fi

          if [ -z "$TAG" ]; then
            echo "::error ::TAG is empty — aborting!" && exit 1
          fi
          echo "→ building ${{ matrix.project }} with tag $TAG"

          ##################################################################
          # 2. Build & push the Docker image – Moon skips if project untouched
          ##################################################################
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            moon run --affected --remote ${{ matrix.project }}:docker-release-pr
          else
            moon run --affected --remote ${{ matrix.project }}:docker-release-prod
          fi

  build_report:
    name: Report Build Outcomes
    runs-on: ubuntu-latest
    needs: [affected, build]
    if: >-
      always() &&
      github.event_name == 'pull_request' &&
      needs.affected.outputs.docker_matrix != '{"project":[]}'
    steps:
      - name: Post Moon run-report after build
        uses: moonrepo/run-report-action@v1
        with:
          access-token: ${{ secrets.GITHUB_TOKEN }}

  #--- 4. DEPLOY WITH COOLIFY --------------------------------------------------

  deploy:
    name: Trigger Coolify deploy
    needs: [build, affected]
    if: needs.build.result == 'success' || (needs.build.result == 'skipped' && needs.affected.outputs.docker_matrix == '{"project":[]}')
    runs-on: ubuntu-latest
    steps:
      - name: Call Coolify API
        env:
          COOLIFY_TOKEN: ${{ secrets.COOLIFY_API_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            curl -s -X POST "${{ vars.COOLIFY_DEPLOY_WEBHOOK }}&pr=${{ github.event.pull_request.number }}" -H "Authorization: Bearer $COOLIFY_TOKEN"
          else
            curl -s -X POST "${{ vars.COOLIFY_DEPLOY_WEBHOOK }}" -H "Authorization: Bearer $COOLIFY_TOKEN"
          fi
      - name: Post Moon run-report after deploy
        if: >-
          always() &&
          github.event_name == 'pull_request' &&
          needs.affected.outputs.docker_matrix != '{"project":[]}'
        uses: moonrepo/run-report-action@v1
        with:
          access-token: ${{ secrets.GITHUB_TOKEN }}
