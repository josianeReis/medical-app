$schema: "https://moonrepo.dev/schemas/project.json"

id: auth
type: application
language: typescript
stack: backend
platform: bun
tags:
  - backend
  - app

project:
  name: "laudos-services/auth"
  description: "Auth"
  channel: "#auth"

tasks:
  lint:
    command: eslint
    options:
      runInCI: true
  lint-fix:
    command: eslint --fix
    options:
      runInCI: true
  local:
    command: infisical run --env local -- bun run --watch --inspect=4011/auth src/index.ts
    # args:
    #   - '--inspect'
    local: true
    deps:
      - "data-access:migration-up"
  dev:
    command: infisical run --env dev -- bun run --watch --inspect=4011/auth src/index.ts
    # args:
    #   - '--inspect'
    local: true
    deps:
      - "data-access:migration-up-dev"
  build:
    command: bun build
    args:
      - "--compile"
      - "--minify-whitespace"
      - "--minify-syntax"
      - "--target=bun"
      - "--outfile=server"
      - "./src/index.ts"
    outputs:
      - "server"
    options:
      runInCI: true
  docker-release-pr:
    command: sh
    args:
      - -c
      - |
        # Build the image
        docker build \
          -t "$REGISTRY/$MOON_PROJECT_ID:$TAG" \
          -f apps/services/auth/Dockerfile .

        echo "→ pushing $MOON_PROJECT_ID with tag $TAG"
        # Push the image to your private registry
        docker push "$REGISTRY/$MOON_PROJECT_ID:$TAG"
    inputs:
      - "$REGISTRY"
      - "$TAG"
    options:
      runFromWorkspaceRoot: true
  docker-release-prod:
    command: sh
    args:
      - -c
      - |
        # Build the image
        docker build \
          -t "$REGISTRY/$MOON_PROJECT_ID:latest" \
          -t "$REGISTRY/$MOON_PROJECT_ID:$TAG" \
          -f apps/services/auth/Dockerfile .

        echo "→ pushing $MOON_PROJECT_ID with tag latest & $TAG"
        # Push the image to your private registry
        docker push "$REGISTRY/$MOON_PROJECT_ID"
    inputs:
      # Pass-through the two variables your GitHub Action injects
      - "$REGISTRY"
      - "$TAG"
    options:
      runFromWorkspaceRoot: true
  start:
    command: infisical run --env prod -- ./server
    inputs:
      - "server"
  migration-create:
    command: bunx @better-auth/cli@latest generate
  openapi-generate:
    command: bun run src/utils/helpers/generateOpenApi.ts

dependsOn:
  - data-access
  - utils
  - email-templates
