id: consumer
type: application
language: typescript
stack: frontend
platform: bun
tags:
  - frontend
  - next
  - app

project:
  name: "nexdoc/consumer"
  description: "Consumer"
  channel: "#consumer"

tasks:
  lint:
    command: next lint
    options:
      runInCI: true
  lint-fix:
    extends: "lint"
    args: "--fix"
    local: true
  install:
    command: bun install
  dev:
    command: infisical run --env dev --path /consumer --command "next dev"
    # args:
    #   - '--turbopack'
    local: true
  stg:
    command: infisical run --env stg --path /consumer --command "next dev"
    # args:
    #   - '--turbopack'
    local: true
  build:
    command: next build
    options:
      runInCI: true
    outputs:
      - ".next"
  docker-release-pr:
    command: sh
    args:
      - -c
      - |
        # Build the image
        docker build \
          -t "$REGISTRY/$MOON_PROJECT_ID:$TAG" \
          -f apps/web/consumer/Dockerfile .

        echo "→ pushing $MOON_PROJECT_ID with tag $TAG"
        # Push the image to your private registry
        docker push "$REGISTRY/$MOON_PROJECT_ID:$TAG"
    # deps: ["build"] # ensures the app is already compiled
    inputs:
      # Pass-through the two variables your GitHub Action injects
      - "$REGISTRY"
      - "$TAG"
    options:
      runFromWorkspaceRoot: true
  docker-release-prod:
    command: sh
    args:
      - -c
      - |
        # Build the image
        docker build \
          -t "$REGISTRY/$MOON_PROJECT_ID:latest" \
          -t "$REGISTRY/$MOON_PROJECT_ID:$TAG" \
          -f apps/web/consumer/Dockerfile .

        echo "→ pushing $MOON_PROJECT_ID with tag latest & $TAG"
        # Push the image to your private registry
        docker push "$REGISTRY/$MOON_PROJECT_ID"
    # deps: ["build"] # ensures the app is already compiled
    inputs:
      # Pass-through the two variables your GitHub Action injects
      - "$REGISTRY"
      - "$TAG"
    options:
      runFromWorkspaceRoot: true
  start:
    command: infisical run --env prod --path /consumer -- next start
    deps:
      - "build"

dependsOn:
  - ui-components
  - utils
